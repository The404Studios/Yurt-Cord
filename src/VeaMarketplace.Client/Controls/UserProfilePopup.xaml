<UserControl x:Class="VeaMarketplace.Client.Controls.UserProfilePopup"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:controls="clr-namespace:VeaMarketplace.Client.Controls"
             xmlns:converters="clr-namespace:VeaMarketplace.Client.Converters"
             Width="340">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVis"/>
        <converters:NullToVisibilityConverter x:Key="NullToVis"/>
    </UserControl.Resources>

    <Border Background="{StaticResource PrimaryDarkBrush}"
            CornerRadius="12"
            Effect="{StaticResource PopupShadow}">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Banner -->
            <Border x:Name="BannerBorder" Grid.Row="0" Height="80" CornerRadius="12,12,0,0">
                <Border.Background>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                        <GradientStop x:Name="BannerColor1" Color="#5865F2" Offset="0"/>
                        <GradientStop x:Name="BannerColor2" Color="#EB459E" Offset="1"/>
                    </LinearGradientBrush>
                </Border.Background>
            </Border>

            <!-- Avatar Section -->
            <Grid Grid.Row="0" Grid.RowSpan="2" Margin="16,40,0,0"
                  HorizontalAlignment="Left" VerticalAlignment="Top">
                <!-- Avatar Ring -->
                <Border Width="92" Height="92" CornerRadius="46"
                        Background="{StaticResource PrimaryDarkBrush}"/>
                <Border Width="84" Height="84" CornerRadius="42"
                        BorderThickness="4" BorderBrush="{StaticResource PrimaryDarkBrush}"
                        HorizontalAlignment="Center" VerticalAlignment="Center">
                    <Ellipse x:Name="AvatarEllipse" Width="76" Height="76">
                        <Ellipse.Fill>
                            <ImageBrush x:Name="AvatarBrush" Stretch="UniformToFill"
                                        ImageSource="/Assets/default-avatar.png"/>
                        </Ellipse.Fill>
                    </Ellipse>
                </Border>

                <!-- Online Status -->
                <Border x:Name="StatusIndicator" Width="28" Height="28" CornerRadius="14"
                        Background="{StaticResource AccentGreenBrush}"
                        BorderThickness="4" BorderBrush="{StaticResource PrimaryDarkBrush}"
                        HorizontalAlignment="Right" VerticalAlignment="Bottom"
                        Margin="0,0,-2,-2"/>
            </Grid>

            <!-- User Info -->
            <StackPanel Grid.Row="1" Margin="16,48,16,0">
                <StackPanel Orientation="Horizontal">
                    <TextBlock x:Name="DisplayNameText" Text="Username"
                               FontSize="22" FontWeight="Bold"
                               Foreground="{StaticResource TextPrimaryBrush}"/>

                    <!-- Verified Badge -->
                    <Border x:Name="VerifiedBadge" Visibility="Collapsed"
                            Background="{StaticResource AccentBrush}"
                            CornerRadius="4" Padding="6,2" Margin="8,0,0,0"
                            VerticalAlignment="Center">
                        <TextBlock Text="âœ“" FontSize="10" FontWeight="Bold" Foreground="White"/>
                    </Border>
                </StackPanel>

                <TextBlock x:Name="UsernameText" Text="@username"
                           FontSize="14" Foreground="{StaticResource TextSecondaryBrush}"
                           Margin="0,2,0,0"/>

                <!-- Custom Status -->
                <Border x:Name="CustomStatusBorder" Visibility="Collapsed"
                        Background="{StaticResource SecondaryDarkBrush}"
                        CornerRadius="6" Padding="8,6" Margin="0,12,0,0">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock x:Name="StatusEmoji" Text="ðŸ˜Š" FontSize="14"/>
                        <TextBlock x:Name="CustomStatusText" Text="Custom status"
                                   FontSize="13" Foreground="{StaticResource TextPrimaryBrush}"
                                   Margin="8,0,0,0"/>
                    </StackPanel>
                </Border>
            </StackPanel>

            <!-- Content Sections -->
            <StackPanel Grid.Row="2" Margin="16,16,16,0">
                <!-- Divider -->
                <Border Height="1" Background="{StaticResource QuaternaryDarkBrush}"/>

                <!-- About Me -->
                <StackPanel x:Name="AboutSection" Visibility="Collapsed" Margin="0,12,0,0">
                    <TextBlock Text="ABOUT ME" FontSize="11" FontWeight="Bold"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               Margin="0,0,0,6"/>
                    <TextBlock x:Name="BioText" TextWrapping="Wrap" MaxHeight="60"
                               FontSize="13" Foreground="{StaticResource TextPrimaryBrush}"/>
                </StackPanel>

                <!-- Mutual Friends -->
                <StackPanel x:Name="MutualFriendsSection" Visibility="Collapsed" Margin="0,12,0,0">
                    <TextBlock FontSize="11" FontWeight="Bold"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               Margin="0,0,0,6">
                        <Run x:Name="MutualFriendsCountText" Text="3"/>
                        <Run Text=" MUTUAL FRIENDS"/>
                    </TextBlock>

                    <StackPanel x:Name="MutualFriendsAvatars" Orientation="Horizontal" Margin="0,4,0,0">
                        <!-- Mutual friend avatars will be added programmatically -->
                    </StackPanel>
                </StackPanel>

                <!-- Member Since and Roles -->
                <Grid Margin="0,12,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0">
                        <TextBlock Text="MEMBER SINCE" FontSize="11" FontWeight="Bold"
                                   Foreground="{StaticResource TextSecondaryBrush}"
                                   Margin="0,0,0,4"/>
                        <TextBlock x:Name="MemberSinceText" Text="Jan 1, 2024"
                                   FontSize="13" Foreground="{StaticResource TextPrimaryBrush}"/>
                    </StackPanel>

                    <StackPanel Grid.Column="1" x:Name="RankSection" Visibility="Collapsed">
                        <TextBlock Text="RANK" FontSize="11" FontWeight="Bold"
                                   Foreground="{StaticResource TextSecondaryBrush}"
                                   Margin="0,0,0,4"/>
                        <Border x:Name="RankBadge" CornerRadius="4" Padding="8,4"
                                HorizontalAlignment="Left">
                            <TextBlock x:Name="RankText" FontSize="12" FontWeight="SemiBold"/>
                        </Border>
                    </StackPanel>
                </Grid>

                <!-- Roles -->
                <StackPanel x:Name="RolesSection" Visibility="Collapsed" Margin="0,12,0,0">
                    <TextBlock Text="ROLES" FontSize="11" FontWeight="Bold"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               Margin="0,0,0,6"/>
                    <ItemsControl x:Name="RolesItemsControl">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border CornerRadius="4" Padding="8,4" Margin="0,0,6,6"
                                        Background="{StaticResource SecondaryDarkBrush}">
                                    <StackPanel Orientation="Horizontal">
                                        <Ellipse Width="8" Height="8" Fill="{Binding Color}"
                                                 Margin="0,0,6,0"/>
                                        <TextBlock Text="{Binding Name}" FontSize="11"
                                                   Foreground="{StaticResource TextPrimaryBrush}"/>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>

                <!-- Note Section -->
                <StackPanel x:Name="NoteSection" Visibility="Collapsed" Margin="0,12,0,0">
                    <TextBlock Text="NOTE" FontSize="11" FontWeight="Bold"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               Margin="0,0,0,6"/>
                    <TextBox x:Name="NoteTextBox"
                             Style="{StaticResource DarkTextBox}"
                             Text="Click to add a note"
                             Background="{StaticResource SecondaryDarkBrush}"
                             Foreground="{StaticResource TextMutedBrush}"
                             Padding="8,6" FontSize="12"
                             GotFocus="NoteTextBox_GotFocus"
                             LostFocus="NoteTextBox_LostFocus"/>
                </StackPanel>
            </StackPanel>

            <!-- Action Buttons -->
            <StackPanel Grid.Row="3" Margin="16,16,16,16">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <Button x:Name="MessageButton" Grid.Column="0"
                            Content="Message" Style="{StaticResource PrimaryButton}"
                            Padding="0,10" Click="MessageButton_Click"/>

                    <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="8,0,0,0">
                        <Button x:Name="CallButton" Style="{StaticResource IconButton}"
                                Width="38" Height="38" ToolTip="Start Call"
                                Click="CallButton_Click">
                            <TextBlock Text="ðŸ“ž" FontSize="16"/>
                        </Button>
                        <Button x:Name="VideoButton" Style="{StaticResource IconButton}"
                                Width="38" Height="38" Margin="4,0,0,0" ToolTip="Start Video Call"
                                Click="VideoButton_Click">
                            <TextBlock Text="ðŸ“¹" FontSize="16"/>
                        </Button>
                        <Button x:Name="MoreButton" Style="{StaticResource IconButton}"
                                Width="38" Height="38" Margin="4,0,0,0" ToolTip="More Options"
                                Click="MoreButton_Click">
                            <TextBlock Text="â‹¯" FontSize="18" FontWeight="Bold"/>
                        </Button>
                    </StackPanel>
                </Grid>

                <!-- Add Friend / Pending / Remove buttons (contextual) -->
                <Button x:Name="FriendActionButton" Visibility="Collapsed"
                        Content="Add Friend" Style="{StaticResource SecondaryButton}"
                        Margin="0,8,0,0" Padding="0,10"
                        Click="FriendActionButton_Click"/>
            </StackPanel>
        </Grid>
    </Border>
</UserControl>
