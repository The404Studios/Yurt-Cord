<UserControl x:Class="VeaMarketplace.Client.Views.MemberSidebar"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:controls="clr-namespace:VeaMarketplace.Client.Controls"
             Background="{StaticResource SecondaryDarkBrush}">

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="../Styles/Colors.xaml"/>
                <ResourceDictionary Source="../Styles/Controls.xaml"/>
            </ResourceDictionary.MergedDictionaries>

            <BooleanToVisibilityConverter x:Key="BoolToVis"/>

            <!-- Member Context Menu -->
            <ContextMenu x:Key="MemberContextMenu" Style="{StaticResource ModernContextMenu}">
                <MenuItem Header="View Profile" Style="{StaticResource ModernMenuItem}"
                          Click="ViewProfile_Click">
                    <MenuItem.Icon>
                        <TextBlock Text="ðŸ‘¤" FontSize="14"/>
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Send Message" Style="{StaticResource ModernMenuItem}"
                          Click="SendMessage_Click">
                    <MenuItem.Icon>
                        <TextBlock Text="ðŸ’¬" FontSize="14"/>
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Add Friend" Style="{StaticResource ModernMenuItem}"
                          Click="AddFriend_Click">
                    <MenuItem.Icon>
                        <TextBlock Text="âž•" FontSize="14"/>
                    </MenuItem.Icon>
                </MenuItem>
                <Separator Style="{StaticResource MenuSeparator}"/>
                <MenuItem Header="Mention" Style="{StaticResource ModernMenuItem}"
                          Click="Mention_Click">
                    <MenuItem.Icon>
                        <TextBlock Text="@" FontSize="14"/>
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Invite to Voice" Style="{StaticResource ModernMenuItem}"
                          Click="InviteToVoice_Click">
                    <MenuItem.Icon>
                        <TextBlock Text="ðŸŽ¤" FontSize="14"/>
                    </MenuItem.Icon>
                </MenuItem>
                <Separator Style="{StaticResource MenuSeparator}"/>
                <MenuItem Header="Mute" Style="{StaticResource ModernMenuItem}"
                          Click="MuteUser_Click">
                    <MenuItem.Icon>
                        <TextBlock Text="ðŸ”‡" FontSize="14"/>
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Block" Style="{StaticResource DangerMenuItem}"
                          Click="BlockUser_Click">
                    <MenuItem.Icon>
                        <TextBlock Text="ðŸš«" FontSize="14"/>
                    </MenuItem.Icon>
                </MenuItem>
                <Separator Style="{StaticResource MenuSeparator}"/>
                <MenuItem Header="Copy User ID" Style="{StaticResource ModernMenuItem}"
                          Click="CopyUserId_Click">
                    <MenuItem.Icon>
                        <TextBlock Text="ðŸ“‹" FontSize="14"/>
                    </MenuItem.Icon>
                </MenuItem>
            </ContextMenu>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header with Group Call Button -->
        <Border Grid.Row="0" Background="{StaticResource PrimaryDarkBrush}" Padding="12,10">
            <Grid>
                <TextBlock Text="MEMBERS" FontSize="11" FontWeight="Bold"
                           Foreground="{StaticResource TextMutedBrush}"
                           VerticalAlignment="Center"/>
                <Button x:Name="GroupCallButton" Style="{StaticResource IconButton}"
                        Width="32" Height="32" HorizontalAlignment="Right"
                        ToolTip="Start Group Call" Click="StartGroupCall_Click">
                    <TextBlock Text="ðŸ“ž" FontSize="16"/>
                </Button>
            </Grid>
        </Border>

        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Style="{StaticResource ModernScrollViewer}">
            <StackPanel Margin="8,12">
                <!-- Online Members Section -->
                <TextBlock x:Name="OnlineHeaderText" Text="ONLINE â€” 0"
                           FontSize="11" FontWeight="SemiBold"
                           Foreground="{StaticResource TextMutedBrush}"
                           Margin="8,0,0,8"/>

                <ItemsControl x:Name="OnlineMembersControl">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Cursor="Hand" Margin="4,2" CornerRadius="6"
                                    Padding="10,8"
                                    ContextMenu="{StaticResource MemberContextMenu}"
                                    Tag="{Binding}"
                                    MouseLeftButtonUp="Member_Click">
                                <Border.Background>
                                    <SolidColorBrush Color="Transparent"/>
                                </Border.Background>
                                <Border.Triggers>
                                    <EventTrigger RoutedEvent="MouseEnter">
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <ColorAnimation Storyboard.TargetProperty="(Border.Background).(SolidColorBrush.Color)"
                                                                To="#34373C" Duration="0:0:0.1"/>
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </EventTrigger>
                                    <EventTrigger RoutedEvent="MouseLeave">
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <ColorAnimation Storyboard.TargetProperty="(Border.Background).(SolidColorBrush.Color)"
                                                                To="Transparent" Duration="0:0:0.1"/>
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </EventTrigger>
                                </Border.Triggers>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Avatar with status -->
                                    <Grid Grid.Column="0" Margin="0,0,12,0">
                                        <Ellipse Width="40" Height="40">
                                            <Ellipse.Fill>
                                                <ImageBrush ImageSource="{Binding AvatarUrl}" Stretch="UniformToFill"/>
                                            </Ellipse.Fill>
                                        </Ellipse>
                                        <!-- Online indicator -->
                                        <Ellipse Width="14" Height="14"
                                                 Fill="{StaticResource AccentGreenBrush}"
                                                 Stroke="{StaticResource SecondaryDarkBrush}"
                                                 StrokeThickness="3"
                                                 HorizontalAlignment="Right"
                                                 VerticalAlignment="Bottom"
                                                 Margin="0,0,-2,-2"/>
                                    </Grid>

                                    <!-- User Info with Nameplate -->
                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                        <controls:UserNameplate Username="{Binding Username}"
                                                                Role="{Binding Role}"
                                                                Rank="{Binding Rank}"
                                                                ShowRoleBadge="True"
                                                                ShowRankBadge="True"
                                                                FontSizeOverride="14"/>
                                        <!-- Status Message -->
                                        <TextBlock Text="{Binding StatusMessage}" FontSize="12"
                                                   Foreground="{StaticResource TextMutedBrush}"
                                                   TextTrimming="CharacterEllipsis"
                                                   MaxWidth="130" Margin="0,2,0,0"
                                                   Visibility="{Binding StatusMessage, Converter={StaticResource StringToVisConverter}}"/>
                                    </StackPanel>

                                    <!-- Quick Actions -->
                                    <StackPanel Grid.Column="2" Orientation="Horizontal"
                                                VerticalAlignment="Center" Visibility="Collapsed"
                                                x:Name="QuickActionsPanel">
                                        <Button Style="{StaticResource IconButton}" Width="28" Height="28"
                                                ToolTip="Send Message" Margin="2,0">
                                            <TextBlock Text="ðŸ’¬" FontSize="12"/>
                                        </Button>
                                        <Button Style="{StaticResource IconButton}" Width="28" Height="28"
                                                ToolTip="Nudge" Margin="2,0">
                                            <TextBlock Text="ðŸ‘‹" FontSize="12"/>
                                        </Button>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- Staff Section -->
                <TextBlock Text="STAFF" FontSize="11" FontWeight="SemiBold"
                           Foreground="{StaticResource TextMutedBrush}"
                           Margin="8,24,0,8"
                           x:Name="StaffHeader" Visibility="Collapsed"/>

                <ItemsControl x:Name="StaffMembersControl" Visibility="Collapsed">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Cursor="Hand" Margin="4,1" CornerRadius="4"
                                    Padding="8,6"
                                    ContextMenu="{StaticResource MemberContextMenu}"
                                    Tag="{Binding}">
                                <Border.Background>
                                    <SolidColorBrush Color="Transparent"/>
                                </Border.Background>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <Grid Grid.Column="0" Margin="0,0,12,0">
                                        <Ellipse Width="32" Height="32">
                                            <Ellipse.Fill>
                                                <ImageBrush ImageSource="{Binding AvatarUrl}" Stretch="UniformToFill"/>
                                            </Ellipse.Fill>
                                        </Ellipse>
                                        <Ellipse Width="12" Height="12"
                                                 Fill="{StaticResource AccentGreenBrush}"
                                                 Stroke="{StaticResource SecondaryDarkBrush}"
                                                 StrokeThickness="2"
                                                 HorizontalAlignment="Right"
                                                 VerticalAlignment="Bottom"
                                                 Margin="0,0,-2,-2"/>
                                    </Grid>

                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                        <controls:UserNameplate Username="{Binding Username}"
                                                                Role="{Binding Role}"
                                                                Rank="{Binding Rank}"
                                                                ShowRoleBadge="True"
                                                                ShowRankBadge="False"
                                                                FontSizeOverride="14"/>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </ScrollViewer>

        <!-- Profile Popup -->
        <Popup x:Name="ProfilePopup" Placement="Left" StaysOpen="False"
               AllowsTransparency="True" Grid.RowSpan="2">
            <Border Background="#1E1F22" CornerRadius="12" Padding="0"
                    Width="320" BorderBrush="#40444B" BorderThickness="1">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="20" ShadowDepth="5" Opacity="0.4"/>
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Banner -->
                    <Border Grid.Row="0" Height="80" CornerRadius="12,12,0,0">
                        <Border.Background>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                <GradientStop x:Name="BannerGradient1" Color="#5865F2" Offset="0"/>
                                <GradientStop x:Name="BannerGradient2" Color="#7289DA" Offset="1"/>
                            </LinearGradientBrush>
                        </Border.Background>
                    </Border>

                    <!-- Avatar -->
                    <Border Grid.Row="0" Grid.RowSpan="2" Width="92" Height="92"
                            CornerRadius="46" Background="#1E1F22"
                            HorizontalAlignment="Left" VerticalAlignment="Bottom"
                            Margin="16,-30,0,0">
                        <Border Width="84" Height="84" CornerRadius="42">
                            <Border.Background>
                                <ImageBrush x:Name="PopupAvatarBrush" Stretch="UniformToFill"/>
                            </Border.Background>
                        </Border>
                    </Border>

                    <!-- User Info -->
                    <StackPanel Grid.Row="1" Margin="16,8,16,0">
                        <StackPanel Orientation="Horizontal" Margin="100,0,0,0">
                            <TextBlock x:Name="PopupUsernameText" FontSize="20" FontWeight="Bold"
                                       Foreground="White"/>
                            <Border x:Name="PopupRoleBadge" Margin="8,0,0,0" CornerRadius="4"
                                    Padding="6,2" Background="#5865F2" VerticalAlignment="Center">
                                <TextBlock x:Name="PopupRoleText" FontSize="10" FontWeight="Bold"
                                           Foreground="White"/>
                            </Border>
                        </StackPanel>
                    </StackPanel>

                    <!-- Details -->
                    <StackPanel Grid.Row="2" Margin="16,16,16,8">
                        <!-- Status -->
                        <Border Background="#2B2D31" CornerRadius="8" Padding="12" Margin="0,0,0,8">
                            <StackPanel>
                                <TextBlock Text="STATUS" FontSize="11" FontWeight="Bold"
                                           Foreground="#B5BAC1" Margin="0,0,0,6"/>
                                <TextBlock x:Name="PopupStatusText" FontSize="14" Foreground="White"
                                           TextWrapping="Wrap"/>
                            </StackPanel>
                        </Border>

                        <!-- Bio -->
                        <Border x:Name="PopupBioSection" Background="#2B2D31" CornerRadius="8"
                                Padding="12" Margin="0,0,0,8" Visibility="Collapsed">
                            <StackPanel>
                                <TextBlock Text="ABOUT ME" FontSize="11" FontWeight="Bold"
                                           Foreground="#B5BAC1" Margin="0,0,0,6"/>
                                <TextBlock x:Name="PopupBioText" FontSize="13" Foreground="#DCDDDE"
                                           TextWrapping="Wrap"/>
                            </StackPanel>
                        </Border>

                        <!-- Member Since -->
                        <Border Background="#2B2D31" CornerRadius="8" Padding="12">
                            <StackPanel>
                                <TextBlock Text="MEMBER SINCE" FontSize="11" FontWeight="Bold"
                                           Foreground="#B5BAC1" Margin="0,0,0,6"/>
                                <TextBlock x:Name="PopupMemberSinceText" FontSize="13" Foreground="#DCDDDE"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>

                    <!-- Actions -->
                    <StackPanel Grid.Row="3" Margin="16,8,16,16" Orientation="Horizontal">
                        <Button Content="ðŸ’¬ Message" Click="PopupMessage_Click" Cursor="Hand"
                                Margin="0,0,8,0">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Background" Value="#5865F2"/>
                                    <Setter Property="Foreground" Value="White"/>
                                    <Setter Property="BorderThickness" Value="0"/>
                                    <Setter Property="Padding" Value="16,8"/>
                                    <Setter Property="FontWeight" Value="Medium"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border Background="{TemplateBinding Background}"
                                                        CornerRadius="6" Padding="{TemplateBinding Padding}">
                                                    <ContentPresenter HorizontalAlignment="Center"
                                                                      VerticalAlignment="Center"/>
                                                </Border>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#4752C4"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <Button Content="âž• Add Friend" Click="PopupAddFriend_Click" Cursor="Hand"
                                Margin="0,0,8,0">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Background" Value="#4F545C"/>
                                    <Setter Property="Foreground" Value="White"/>
                                    <Setter Property="BorderThickness" Value="0"/>
                                    <Setter Property="Padding" Value="16,8"/>
                                    <Setter Property="FontWeight" Value="Medium"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border Background="{TemplateBinding Background}"
                                                        CornerRadius="6" Padding="{TemplateBinding Padding}">
                                                    <ContentPresenter HorizontalAlignment="Center"
                                                                      VerticalAlignment="Center"/>
                                                </Border>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#5D6269"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <Button Content="ðŸ‘‹" ToolTip="Nudge" Click="PopupNudge_Click" Cursor="Hand">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Background" Value="#4F545C"/>
                                    <Setter Property="Foreground" Value="White"/>
                                    <Setter Property="BorderThickness" Value="0"/>
                                    <Setter Property="Padding" Value="10,8"/>
                                    <Setter Property="FontSize" Value="16"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border Background="{TemplateBinding Background}"
                                                        CornerRadius="6" Padding="{TemplateBinding Padding}">
                                                    <ContentPresenter HorizontalAlignment="Center"
                                                                      VerticalAlignment="Center"/>
                                                </Border>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#5D6269"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>
        </Popup>
    </Grid>
</UserControl>
