<UserControl x:Class="VeaMarketplace.Client.Views.FriendsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:controls="clr-namespace:VeaMarketplace.Client.Controls"
             xmlns:converters="clr-namespace:VeaMarketplace.Client.Converters"
             Background="{StaticResource TertiaryDarkBrush}">

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="../Styles/Colors.xaml"/>
                <ResourceDictionary Source="../Styles/Buttons.xaml"/>
                <ResourceDictionary Source="../Styles/Controls.xaml"/>
            </ResourceDictionary.MergedDictionaries>

            <BooleanToVisibilityConverter x:Key="BoolToVis"/>
            <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVis"/>
            <converters:StringToVisibilityConverter x:Key="StringToVisConverter"/>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="280"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Left Panel: Friends/DM List -->
        <Border Grid.Column="0" Background="{StaticResource SecondaryDarkBrush}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Header -->
                <Border Grid.Row="0" Height="48" BorderBrush="{StaticResource PrimaryDarkBrush}"
                        BorderThickness="0,0,0,1">
                    <Grid Margin="16,0">
                        <TextBlock Text="Friends" FontSize="16" FontWeight="Bold"
                                   Foreground="{StaticResource TextPrimaryBrush}"
                                   VerticalAlignment="Center"/>
                    </Grid>
                </Border>

                <!-- View Switcher -->
                <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="8">
                    <Button Content="All" Style="{StaticResource SecondaryButton}"
                            Margin="0,0,4,0" Padding="12,6"
                            Command="{Binding SwitchViewCommand}" CommandParameter="Friends"/>
                    <Button Content="Pending" Style="{StaticResource SecondaryButton}"
                            Margin="0,0,4,0" Padding="12,6"
                            Command="{Binding SwitchViewCommand}" CommandParameter="Pending"/>
                    <Button Content="Add" Style="{StaticResource SecondaryButton}"
                            Padding="12,6"
                            Command="{Binding SwitchViewCommand}" CommandParameter="Add"/>
                </StackPanel>

                <!-- Content based on view -->
                <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto"
                              Style="{StaticResource ModernScrollViewer}">
                    <StackPanel>
                        <!-- Add Friend View -->
                        <StackPanel Visibility="{Binding CurrentView, Converter={StaticResource StringToVisConverter}, ConverterParameter=Add}">
                            <Border Background="{StaticResource PrimaryDarkBrush}" CornerRadius="4"
                                    Margin="8" Padding="12">
                                <StackPanel>
                                    <TextBlock Text="ADD FRIEND" FontSize="12" FontWeight="Bold"
                                               Foreground="{StaticResource TextMutedBrush}"
                                               Margin="0,0,0,8"/>
                                    <TextBlock Text="Enter a username to send a friend request"
                                               FontSize="12" Foreground="{StaticResource TextSecondaryBrush}"
                                               TextWrapping="Wrap" Margin="0,0,0,12"/>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBox Grid.Column="0" Style="{StaticResource ModernTextBox}"
                                                 Text="{Binding FriendRequestUsername, UpdateSourceTrigger=PropertyChanged}"
                                                 Margin="0,0,8,0"/>
                                        <Button Grid.Column="1" Content="Send"
                                                Style="{StaticResource PrimaryButton}"
                                                Command="{Binding SendFriendRequestCommand}"/>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- Outgoing Requests -->
                            <TextBlock Text="PENDING - SENT" FontSize="11" FontWeight="SemiBold"
                                       Foreground="{StaticResource TextMutedBrush}"
                                       Margin="16,16,16,8"/>
                            <ItemsControl ItemsSource="{Binding OutgoingRequests}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="{StaticResource QuaternaryDarkBrush}"
                                                CornerRadius="4" Margin="8,2" Padding="12,8">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <Ellipse Grid.Column="0" Width="32" Height="32" Margin="0,0,12,0">
                                                    <Ellipse.Fill>
                                                        <ImageBrush ImageSource="{Binding RequesterAvatarUrl}"/>
                                                    </Ellipse.Fill>
                                                </Ellipse>
                                                <TextBlock Grid.Column="1" Text="{Binding RequesterUsername}"
                                                           Foreground="{StaticResource TextPrimaryBrush}"
                                                           VerticalAlignment="Center"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>

                        <!-- Pending Requests View -->
                        <StackPanel Visibility="{Binding CurrentView, Converter={StaticResource StringToVisConverter}, ConverterParameter=Pending}">
                            <TextBlock Text="INCOMING REQUESTS" FontSize="11" FontWeight="SemiBold"
                                       Foreground="{StaticResource TextMutedBrush}"
                                       Margin="16,8"/>
                            <ItemsControl ItemsSource="{Binding PendingRequests}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="{StaticResource QuaternaryDarkBrush}"
                                                CornerRadius="4" Margin="8,2" Padding="12,8">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <Ellipse Grid.Column="0" Width="32" Height="32" Margin="0,0,12,0">
                                                    <Ellipse.Fill>
                                                        <ImageBrush ImageSource="{Binding RequesterAvatarUrl}"/>
                                                    </Ellipse.Fill>
                                                </Ellipse>
                                                <TextBlock Grid.Column="1" Text="{Binding RequesterUsername}"
                                                           Foreground="{StaticResource TextPrimaryBrush}"
                                                           VerticalAlignment="Center"/>
                                                <StackPanel Grid.Column="2" Orientation="Horizontal">
                                                    <Button Content="Accept" Style="{StaticResource PrimaryButton}"
                                                            Padding="8,4" Margin="0,0,4,0"
                                                            Command="{Binding DataContext.AcceptFriendRequestCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                            CommandParameter="{Binding}"/>
                                                    <Button Content="X" Style="{StaticResource SecondaryButton}"
                                                            Padding="8,4"
                                                            Command="{Binding DataContext.DeclineFriendRequestCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                            CommandParameter="{Binding}"/>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>

                        <!-- Friends List View -->
                        <StackPanel Visibility="{Binding CurrentView, Converter={StaticResource StringToVisConverter}, ConverterParameter=Friends}">
                            <TextBlock Text="ONLINE" FontSize="11" FontWeight="SemiBold"
                                       Foreground="{StaticResource TextMutedBrush}"
                                       Margin="16,8"/>
                            <ItemsControl ItemsSource="{Binding Friends}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Style="{StaticResource ChannelButton}"
                                                Command="{Binding DataContext.OpenDMCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}">
                                            <Grid Margin="8,4">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <!-- Avatar with online status -->
                                                <Grid Grid.Column="0" Margin="0,0,12,0">
                                                    <Ellipse Width="32" Height="32">
                                                        <Ellipse.Fill>
                                                            <ImageBrush ImageSource="{Binding AvatarUrl}"/>
                                                        </Ellipse.Fill>
                                                    </Ellipse>
                                                    <Ellipse Width="12" Height="12"
                                                             HorizontalAlignment="Right" VerticalAlignment="Bottom"
                                                             Stroke="{StaticResource SecondaryDarkBrush}" StrokeThickness="2">
                                                        <Ellipse.Style>
                                                            <Style TargetType="Ellipse">
                                                                <Setter Property="Fill" Value="{StaticResource TextMutedBrush}"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsOnline}" Value="True">
                                                                        <Setter Property="Fill" Value="{StaticResource AccentGreenBrush}"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Ellipse.Style>
                                                    </Ellipse>
                                                </Grid>

                                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding Username}"
                                                               Foreground="{StaticResource TextPrimaryBrush}"
                                                               FontWeight="Medium"/>
                                                    <TextBlock FontSize="11">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Text" Value="Offline"/>
                                                                <Setter Property="Foreground" Value="{StaticResource TextMutedBrush}"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsOnline}" Value="True">
                                                                        <Setter Property="Text" Value="Online"/>
                                                                        <Setter Property="Foreground" Value="{StaticResource AccentGreenBrush}"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </StackPanel>

                                                <!-- Call button -->
                                                <Button Grid.Column="2" Style="{StaticResource IconButton}"
                                                        Width="32" Height="32"
                                                        Command="{Binding DataContext.StartCallCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        CommandParameter="{Binding}"
                                                        Visibility="{Binding IsOnline, Converter={StaticResource BoolToVis}}">
                                                    <TextBlock Text="ðŸ“ž" FontSize="16"/>
                                                </Button>
                                            </Grid>
                                        </Button>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Border>

        <!-- Right Panel: DM Chat or Welcome -->
        <Border Grid.Column="1">
            <Grid>
                <!-- Welcome/Empty State -->
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center"
                            Visibility="{Binding IsInDMView, Converter={StaticResource InverseBoolToVis}}">
                    <TextBlock Text="Select a friend to start chatting"
                               FontSize="18" Foreground="{StaticResource TextMutedBrush}"
                               HorizontalAlignment="Center"/>
                </StackPanel>

                <!-- DM Chat -->
                <Grid Visibility="{Binding IsInDMView, Converter={StaticResource BoolToVis}}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="48"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- DM Header -->
                    <Border Grid.Row="0" BorderBrush="{StaticResource PrimaryDarkBrush}"
                            BorderThickness="0,0,0,1">
                        <Grid Margin="16,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <Button Grid.Column="0" Content="Back" Style="{StaticResource SecondaryButton}"
                                    Margin="0,0,12,0" Padding="8,4"
                                    Command="{Binding CloseDMCommand}"/>

                            <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                                <Ellipse Width="24" Height="24" Margin="0,0,8,0">
                                    <Ellipse.Fill>
                                        <ImageBrush ImageSource="{Binding SelectedFriend.AvatarUrl}"/>
                                    </Ellipse.Fill>
                                </Ellipse>
                                <TextBlock Text="{Binding SelectedFriend.Username}"
                                           FontSize="16" FontWeight="Bold"
                                           Foreground="{StaticResource TextPrimaryBrush}"/>
                            </StackPanel>

                            <Button Grid.Column="2" Style="{StaticResource IconButton}"
                                    Width="32" Height="32"
                                    Command="{Binding StartCallCommand}"
                                    CommandParameter="{Binding SelectedFriend}">
                                <TextBlock Text="ðŸ“ž" FontSize="16"/>
                            </Button>
                        </Grid>
                    </Border>

                    <!-- Messages -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto"
                                  Style="{StaticResource ModernScrollViewer}">
                        <ItemsControl ItemsSource="{Binding CurrentDMHistory}" Margin="16,8">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="0,4">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>

                                        <Ellipse Grid.Column="0" Width="40" Height="40"
                                                 Margin="0,0,12,0" VerticalAlignment="Top">
                                            <Ellipse.Fill>
                                                <ImageBrush ImageSource="{Binding SenderAvatarUrl}"/>
                                            </Ellipse.Fill>
                                        </Ellipse>

                                        <StackPanel Grid.Column="1">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding SenderUsername}"
                                                           FontWeight="Medium"
                                                           Foreground="{StaticResource TextPrimaryBrush}"/>
                                                <TextBlock Text="{Binding Timestamp, StringFormat=' {0:h:mm tt}'}"
                                                           FontSize="11"
                                                           Foreground="{StaticResource TextMutedBrush}"
                                                           Margin="8,0,0,0"/>
                                            </StackPanel>
                                            <TextBlock Text="{Binding Content}"
                                                       Foreground="{StaticResource TextSecondaryBrush}"
                                                       TextWrapping="Wrap"/>
                                        </StackPanel>
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

                    <!-- Message Input -->
                    <Border Grid.Row="2" Margin="16,8,16,16">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0" Style="{StaticResource ChatInputTextBox}"
                                     Text="{Binding DmMessageInput, UpdateSourceTrigger=PropertyChanged}">
                                <TextBox.InputBindings>
                                    <KeyBinding Key="Return" Command="{Binding SendDMCommand}"/>
                                </TextBox.InputBindings>
                            </TextBox>
                            <Button Grid.Column="1" Content="Send" Style="{StaticResource PrimaryButton}"
                                    Margin="8,0,0,0"
                                    Command="{Binding SendDMCommand}"/>
                        </Grid>
                    </Border>
                </Grid>
            </Grid>
        </Border>

        <!-- Call Overlay -->
        <Grid Grid.ColumnSpan="2" Background="#E0202225"
              Visibility="{Binding IsInCall, Converter={StaticResource BoolToVis}}">
            <Border Background="{StaticResource SecondaryDarkBrush}"
                    CornerRadius="16" Width="400" Height="500"
                    VerticalAlignment="Center" HorizontalAlignment="Center">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <!-- Call User Info -->
                    <Grid Margin="0,0,0,24">
                        <Ellipse Width="120" Height="120">
                            <Ellipse.Fill>
                                <ImageBrush ImageSource="{Binding SelectedFriend.AvatarUrl}"/>
                            </Ellipse.Fill>
                        </Ellipse>
                        <!-- Voice activity ring (White indicator when speaking) -->
                        <Ellipse Width="130" Height="130"
                                 Stroke="White"
                                 StrokeThickness="3"
                                 Visibility="{Binding IsCallUserSpeaking, Converter={StaticResource BoolToVis}}"/>
                    </Grid>

                    <TextBlock Text="{Binding SelectedFriend.Username}"
                               FontSize="24" FontWeight="Bold"
                               Foreground="{StaticResource TextPrimaryBrush}"
                               HorizontalAlignment="Center"/>

                    <TextBlock Text="{Binding CallDuration}"
                               FontSize="18"
                               Foreground="{StaticResource AccentGreenBrush}"
                               HorizontalAlignment="Center"
                               Margin="0,8,0,0"/>

                    <!-- Call Controls -->
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,32,0,0">
                        <Button Style="{StaticResource IconButton}" Width="56" Height="56"
                                Background="{StaticResource AccentRedBrush}"
                                Command="{Binding EndCallCommand}">
                            <TextBlock Text="ðŸ“µ" FontSize="24"/>
                        </Button>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>

        <!-- Incoming Call Overlay -->
        <Grid Grid.ColumnSpan="2" Background="#E0202225"
              Visibility="{Binding HasIncomingCall, Converter={StaticResource BoolToVis}}">
            <Border Background="{StaticResource SecondaryDarkBrush}"
                    CornerRadius="16" Width="350" Height="400"
                    VerticalAlignment="Center" HorizontalAlignment="Center">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <Ellipse Width="100" Height="100" Margin="0,0,0,24">
                        <Ellipse.Fill>
                            <ImageBrush ImageSource="{Binding CurrentCall.CallerAvatarUrl}"/>
                        </Ellipse.Fill>
                    </Ellipse>

                    <TextBlock Text="{Binding CurrentCall.CallerUsername}"
                               FontSize="20" FontWeight="Bold"
                               Foreground="{StaticResource TextPrimaryBrush}"
                               HorizontalAlignment="Center"/>

                    <TextBlock Text="Incoming Call..."
                               FontSize="14"
                               Foreground="{StaticResource TextMutedBrush}"
                               HorizontalAlignment="Center"
                               Margin="0,8,0,0"/>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,32,0,0">
                        <Button Style="{StaticResource IconButton}" Width="56" Height="56"
                                Background="{StaticResource AccentRedBrush}"
                                Margin="0,0,24,0"
                                Command="{Binding DeclineCallCommand}">
                            <TextBlock Text="ðŸ“µ" FontSize="24"/>
                        </Button>
                        <Button Style="{StaticResource IconButton}" Width="56" Height="56"
                                Background="{StaticResource AccentGreenBrush}"
                                Command="{Binding AcceptCallCommand}">
                            <TextBlock Text="ðŸ“ž" FontSize="24"/>
                        </Button>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</UserControl>
