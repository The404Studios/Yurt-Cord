<UserControl x:Class="VeaMarketplace.Client.Views.FriendsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:controls="clr-namespace:VeaMarketplace.Client.Controls"
             xmlns:converters="clr-namespace:VeaMarketplace.Client.Converters"
             Background="{StaticResource TertiaryDarkBrush}">

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="../Styles/Colors.xaml"/>
                <ResourceDictionary Source="../Styles/Buttons.xaml"/>
                <ResourceDictionary Source="../Styles/Controls.xaml"/>
            </ResourceDictionary.MergedDictionaries>

            <BooleanToVisibilityConverter x:Key="BoolToVis"/>
            <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVis"/>
            <converters:StringToVisibilityConverter x:Key="StringToVisConverter"/>
            <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="280"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Left Panel: Friends/DM List -->
        <Border Grid.Column="0" Background="{StaticResource SecondaryDarkBrush}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Header -->
                <Border Grid.Row="0" Height="48" BorderBrush="{StaticResource PrimaryDarkBrush}"
                        BorderThickness="0,0,0,1">
                    <Grid Margin="16,0">
                        <TextBlock Text="Friends" FontSize="16" FontWeight="Bold"
                                   Foreground="{StaticResource TextPrimaryBrush}"
                                   VerticalAlignment="Center"/>
                    </Grid>
                </Border>

                <!-- View Switcher -->
                <ScrollViewer Grid.Row="1" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                    <StackPanel Orientation="Horizontal" Margin="8">
                        <Button Content="All" Style="{StaticResource SecondaryButton}"
                                Margin="0,0,4,0" Padding="12,6"
                                Command="{Binding SwitchViewCommand}" CommandParameter="Friends"/>
                        <Button Style="{StaticResource SecondaryButton}"
                                Margin="0,0,4,0" Padding="12,6"
                                Command="{Binding SwitchViewCommand}" CommandParameter="Conversations">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="DMs"/>
                                <Border Background="{StaticResource AccentRedBrush}" CornerRadius="8"
                                        Padding="6,2" Margin="6,0,0,0"
                                        Visibility="{Binding UnreadConversationsCount, Converter={StaticResource CountToVisibilityConverter}}">
                                    <TextBlock Text="{Binding UnreadConversationsCount}" FontSize="10" Foreground="White"/>
                                </Border>
                            </StackPanel>
                        </Button>
                        <Button Style="{StaticResource SecondaryButton}"
                                Margin="0,0,4,0" Padding="12,6"
                                Command="{Binding SwitchViewCommand}" CommandParameter="Pending">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="Pending"/>
                                <Border Background="{StaticResource AccentGreenBrush}" CornerRadius="8"
                                        Padding="6,2" Margin="6,0,0,0"
                                        Visibility="{Binding PendingRequestsCount, Converter={StaticResource CountToVisibilityConverter}}">
                                    <TextBlock Text="{Binding PendingRequestsCount}" FontSize="10" Foreground="White"/>
                                </Border>
                            </StackPanel>
                        </Button>
                        <Button Content="Add" Style="{StaticResource SecondaryButton}"
                                Margin="0,0,4,0" Padding="12,6"
                                Command="{Binding SwitchViewCommand}" CommandParameter="Add"/>
                        <Button Content="Blocked" Style="{StaticResource SecondaryButton}"
                                Padding="12,6"
                                Command="{Binding SwitchViewCommand}" CommandParameter="Blocked"/>
                    </StackPanel>
                </ScrollViewer>

                <!-- Content based on view -->
                <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto"
                              Style="{StaticResource ModernScrollViewer}">
                    <StackPanel>
                        <!-- Add Friend View -->
                        <StackPanel Visibility="{Binding CurrentView, Converter={StaticResource StringToVisConverter}, ConverterParameter=Add}">
                            <Border Background="{StaticResource PrimaryDarkBrush}" CornerRadius="4"
                                    Margin="8" Padding="12">
                                <StackPanel>
                                    <TextBlock Text="ADD FRIEND" FontSize="12" FontWeight="Bold"
                                               Foreground="{StaticResource TextMutedBrush}"
                                               Margin="0,0,0,8"/>
                                    <TextBlock Text="You can add friends with their username"
                                               FontSize="12" Foreground="{StaticResource TextSecondaryBrush}"
                                               TextWrapping="Wrap" Margin="0,0,0,12"/>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBox Grid.Column="0" Style="{StaticResource ModernTextBox}"
                                                 Text="{Binding FriendRequestUsername, UpdateSourceTrigger=PropertyChanged}"
                                                 Margin="0,0,8,0"/>
                                        <Button Grid.Column="1" Content="Send Friend Request"
                                                Style="{StaticResource PrimaryButton}"
                                                Command="{Binding SendFriendRequestCommand}"
                                                IsEnabled="{Binding CanSendFriendRequest}"/>
                                    </Grid>

                                    <!-- Search Status -->
                                    <Grid Margin="0,12,0,0">
                                        <!-- Loading Indicator -->
                                        <StackPanel Orientation="Horizontal"
                                                    Visibility="{Binding IsSearchingUser, Converter={StaticResource BoolToVis}}">
                                            <TextBlock Text="Searching..." FontSize="12"
                                                       Foreground="{StaticResource TextMutedBrush}"/>
                                        </StackPanel>

                                        <!-- User Found Card -->
                                        <Border Background="{StaticResource QuaternaryDarkBrush}"
                                                CornerRadius="8" Padding="12"
                                                Visibility="{Binding SearchedUser, Converter={StaticResource NullToVisibilityConverter}}">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <!-- Avatar -->
                                                <Grid Grid.Column="0" Margin="0,0,12,0">
                                                    <Ellipse Width="40" Height="40">
                                                        <Ellipse.Fill>
                                                            <ImageBrush ImageSource="{Binding SearchedUser.AvatarUrl}"/>
                                                        </Ellipse.Fill>
                                                    </Ellipse>
                                                    <!-- Online status -->
                                                    <Ellipse Width="12" Height="12"
                                                             HorizontalAlignment="Right" VerticalAlignment="Bottom"
                                                             Stroke="{StaticResource QuaternaryDarkBrush}" StrokeThickness="2">
                                                        <Ellipse.Style>
                                                            <Style TargetType="Ellipse">
                                                                <Setter Property="Fill" Value="{StaticResource TextMutedBrush}"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding SearchedUser.IsOnline}" Value="True">
                                                                        <Setter Property="Fill" Value="{StaticResource AccentGreenBrush}"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Ellipse.Style>
                                                    </Ellipse>
                                                </Grid>

                                                <!-- User Info -->
                                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding SearchedUser.Username}"
                                                               FontWeight="SemiBold" FontSize="14"
                                                               Foreground="{StaticResource TextPrimaryBrush}"/>
                                                    <TextBlock Text="{Binding SearchedUser.DisplayName}"
                                                               FontSize="12"
                                                               Foreground="{StaticResource TextMutedBrush}"
                                                               Visibility="{Binding SearchedUser.DisplayName, Converter={StaticResource NullToVisibilityConverter}}"/>
                                                </StackPanel>

                                                <!-- View Profile / Already Friends Badge -->
                                                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                                                    <Button Content="Profile"
                                                            Style="{StaticResource SecondaryButton}"
                                                            Padding="8,4" Margin="0,0,8,0"
                                                            Command="{Binding ViewSearchedUserProfileCommand}"/>
                                                    <Border Background="{StaticResource AccentGreenBrush}"
                                                            CornerRadius="4" Padding="8,4"
                                                            Visibility="{Binding SearchedUser.IsFriend, Converter={StaticResource BoolToVis}}">
                                                        <TextBlock Text="Friends" FontSize="11" FontWeight="SemiBold"
                                                                   Foreground="White"/>
                                                    </Border>
                                                </StackPanel>
                                            </Grid>
                                        </Border>

                                        <!-- User Not Found Message -->
                                        <TextBlock Text="{Binding UserSearchMessage}"
                                                   FontSize="12" Foreground="{StaticResource AccentRedBrush}"
                                                   Visibility="{Binding UserSearchMessage, Converter={StaticResource NullToVisibilityConverter}}"/>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- Outgoing Requests -->
                            <TextBlock Text="PENDING - SENT" FontSize="11" FontWeight="SemiBold"
                                       Foreground="{StaticResource TextMutedBrush}"
                                       Margin="16,16,16,8"/>
                            <ItemsControl ItemsSource="{Binding OutgoingRequests}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="{StaticResource QuaternaryDarkBrush}"
                                                CornerRadius="4" Margin="8,2" Padding="12,8">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <Ellipse Grid.Column="0" Width="32" Height="32" Margin="0,0,12,0">
                                                    <Ellipse.Fill>
                                                        <ImageBrush ImageSource="{Binding RequesterAvatarUrl}"/>
                                                    </Ellipse.Fill>
                                                </Ellipse>
                                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding RequesterUsername}"
                                                               Foreground="{StaticResource TextPrimaryBrush}"/>
                                                    <TextBlock Text="Pending" FontSize="11"
                                                               Foreground="{StaticResource TextMutedBrush}"/>
                                                </StackPanel>
                                                <Button Grid.Column="2" Content="Cancel" Style="{StaticResource SecondaryButton}"
                                                        Padding="8,4"
                                                        Command="{Binding DataContext.CancelFriendRequestCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        CommandParameter="{Binding}"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>

                        <!-- Pending Requests View -->
                        <StackPanel Visibility="{Binding CurrentView, Converter={StaticResource StringToVisConverter}, ConverterParameter=Pending}">
                            <TextBlock Text="INCOMING REQUESTS" FontSize="11" FontWeight="SemiBold"
                                       Foreground="{StaticResource TextMutedBrush}"
                                       Margin="16,8"/>
                            <ItemsControl ItemsSource="{Binding PendingRequests}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="{StaticResource QuaternaryDarkBrush}"
                                                CornerRadius="4" Margin="8,2" Padding="12,8">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <Ellipse Grid.Column="0" Width="32" Height="32" Margin="0,0,12,0">
                                                    <Ellipse.Fill>
                                                        <ImageBrush ImageSource="{Binding RequesterAvatarUrl}"/>
                                                    </Ellipse.Fill>
                                                </Ellipse>
                                                <TextBlock Grid.Column="1" Text="{Binding RequesterUsername}"
                                                           Foreground="{StaticResource TextPrimaryBrush}"
                                                           VerticalAlignment="Center"/>
                                                <StackPanel Grid.Column="2" Orientation="Horizontal">
                                                    <Button Content="Accept" Style="{StaticResource PrimaryButton}"
                                                            Padding="8,4" Margin="0,0,4,0"
                                                            Command="{Binding DataContext.AcceptFriendRequestCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                            CommandParameter="{Binding}"/>
                                                    <Button Content="X" Style="{StaticResource SecondaryButton}"
                                                            Padding="8,4"
                                                            Command="{Binding DataContext.DeclineFriendRequestCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                            CommandParameter="{Binding}"/>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>

                        <!-- Friends List View -->
                        <StackPanel Visibility="{Binding CurrentView, Converter={StaticResource StringToVisConverter}, ConverterParameter=Friends}">
                            <TextBlock FontSize="11" FontWeight="SemiBold"
                                       Foreground="{StaticResource TextMutedBrush}"
                                       Margin="16,8">
                                <Run Text="ALL FRIENDS â€” "/>
                                <Run Text="{Binding TotalFriendsCount, Mode=OneWay}"/>
                            </TextBlock>
                            <ItemsControl ItemsSource="{Binding Friends}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Style="{StaticResource ChannelButton}"
                                                Command="{Binding DataContext.OpenDMCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}">
                                            <Button.ContextMenu>
                                                <ContextMenu>
                                                    <MenuItem Header="View Profile"
                                                              Command="{Binding DataContext.ViewFriendProfileCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                              CommandParameter="{Binding}"/>
                                                    <MenuItem Header="Message"
                                                              Command="{Binding DataContext.OpenDMCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                              CommandParameter="{Binding}"/>
                                                    <MenuItem Header="Start Call"
                                                              Command="{Binding DataContext.StartCallCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                              CommandParameter="{Binding}"/>
                                                    <MenuItem Header="Nudge"
                                                              Command="{Binding DataContext.SendNudgeCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                              CommandParameter="{Binding}"/>
                                                    <Separator/>
                                                    <MenuItem Header="Remove Friend" Foreground="{StaticResource AccentRedBrush}"
                                                              Command="{Binding DataContext.RemoveFriendCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                              CommandParameter="{Binding}"/>
                                                    <MenuItem Header="Block" Foreground="{StaticResource AccentRedBrush}"
                                                              Command="{Binding DataContext.OpenBlockDialogCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                              CommandParameter="{Binding}"/>
                                                </ContextMenu>
                                            </Button.ContextMenu>
                                            <Grid Margin="8,4">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <!-- Avatar with online status -->
                                                <Grid Grid.Column="0" Margin="0,0,12,0">
                                                    <Ellipse Width="32" Height="32">
                                                        <Ellipse.Fill>
                                                            <ImageBrush ImageSource="{Binding AvatarUrl}"/>
                                                        </Ellipse.Fill>
                                                    </Ellipse>
                                                    <Ellipse Width="12" Height="12"
                                                             HorizontalAlignment="Right" VerticalAlignment="Bottom"
                                                             Stroke="{StaticResource SecondaryDarkBrush}" StrokeThickness="2">
                                                        <Ellipse.Style>
                                                            <Style TargetType="Ellipse">
                                                                <Setter Property="Fill" Value="{StaticResource TextMutedBrush}"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsOnline}" Value="True">
                                                                        <Setter Property="Fill" Value="{StaticResource AccentGreenBrush}"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Ellipse.Style>
                                                    </Ellipse>
                                                </Grid>

                                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding Username}"
                                                               Foreground="{StaticResource TextPrimaryBrush}"
                                                               FontWeight="Medium"/>
                                                    <TextBlock FontSize="11">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Text" Value="Offline"/>
                                                                <Setter Property="Foreground" Value="{StaticResource TextMutedBrush}"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsOnline}" Value="True">
                                                                        <Setter Property="Text" Value="Online"/>
                                                                        <Setter Property="Foreground" Value="{StaticResource AccentGreenBrush}"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </StackPanel>

                                                <!-- Call button -->
                                                <Button Grid.Column="2" Style="{StaticResource IconButton}"
                                                        Width="32" Height="32"
                                                        Command="{Binding DataContext.StartCallCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        CommandParameter="{Binding}"
                                                        Visibility="{Binding IsOnline, Converter={StaticResource BoolToVis}}">
                                                    <TextBlock Text="ðŸ“ž" FontSize="16"/>
                                                </Button>
                                            </Grid>
                                        </Button>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>

                        <!-- Conversations View -->
                        <StackPanel Visibility="{Binding CurrentView, Converter={StaticResource StringToVisConverter}, ConverterParameter=Conversations}">
                            <TextBlock Text="DIRECT MESSAGES" FontSize="11" FontWeight="SemiBold"
                                       Foreground="{StaticResource TextMutedBrush}"
                                       Margin="16,8"/>
                            <ItemsControl ItemsSource="{Binding Conversations}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Style="{StaticResource ChannelButton}"
                                                Command="{Binding DataContext.OpenConversationCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}">
                                            <Grid Margin="8,4">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <!-- Avatar with online status -->
                                                <Grid Grid.Column="0" Margin="0,0,12,0">
                                                    <Ellipse Width="40" Height="40">
                                                        <Ellipse.Fill>
                                                            <ImageBrush ImageSource="{Binding AvatarUrl}"/>
                                                        </Ellipse.Fill>
                                                    </Ellipse>
                                                    <Ellipse Width="12" Height="12"
                                                             HorizontalAlignment="Right" VerticalAlignment="Bottom"
                                                             Stroke="{StaticResource SecondaryDarkBrush}" StrokeThickness="2">
                                                        <Ellipse.Style>
                                                            <Style TargetType="Ellipse">
                                                                <Setter Property="Fill" Value="{StaticResource TextMutedBrush}"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsOnline}" Value="True">
                                                                        <Setter Property="Fill" Value="{StaticResource AccentGreenBrush}"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Ellipse.Style>
                                                    </Ellipse>
                                                </Grid>

                                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding Username}"
                                                               Foreground="{StaticResource TextPrimaryBrush}"
                                                               FontWeight="Medium"/>
                                                    <TextBlock Text="{Binding LastMessage}" FontSize="12"
                                                               Foreground="{StaticResource TextMutedBrush}"
                                                               TextTrimming="CharacterEllipsis"
                                                               MaxWidth="150"/>
                                                </StackPanel>

                                                <!-- Unread badge -->
                                                <Border Grid.Column="2" Background="{StaticResource AccentRedBrush}"
                                                        CornerRadius="10" Padding="8,2"
                                                        VerticalAlignment="Center"
                                                        Visibility="{Binding UnreadCount, Converter={StaticResource CountToVisibilityConverter}}">
                                                    <TextBlock Text="{Binding UnreadCount}" FontSize="11"
                                                               Foreground="White" FontWeight="Bold"/>
                                                </Border>
                                            </Grid>
                                        </Button>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>

                        <!-- Blocked Users View -->
                        <StackPanel Visibility="{Binding CurrentView, Converter={StaticResource StringToVisConverter}, ConverterParameter=Blocked}">
                            <TextBlock Text="BLOCKED USERS" FontSize="11" FontWeight="SemiBold"
                                       Foreground="{StaticResource TextMutedBrush}"
                                       Margin="16,8"/>
                            <TextBlock Text="Users you've blocked won't be able to message you or see your online status."
                                       FontSize="12" Foreground="{StaticResource TextMutedBrush}"
                                       TextWrapping="Wrap" Margin="16,0,16,16"/>
                            <ItemsControl ItemsSource="{Binding BlockedUsers}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="{StaticResource QuaternaryDarkBrush}"
                                                CornerRadius="4" Margin="8,2" Padding="12,8">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <Ellipse Grid.Column="0" Width="32" Height="32" Margin="0,0,12,0">
                                                    <Ellipse.Fill>
                                                        <ImageBrush ImageSource="{Binding AvatarUrl}"/>
                                                    </Ellipse.Fill>
                                                </Ellipse>
                                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding Username}"
                                                               Foreground="{StaticResource TextPrimaryBrush}"/>
                                                    <TextBlock FontSize="11" Foreground="{StaticResource TextMutedBrush}">
                                                        <Run Text="Blocked"/>
                                                        <Run Text="{Binding BlockedAt, StringFormat=' {0:MMM d, yyyy}'}"/>
                                                    </TextBlock>
                                                </StackPanel>
                                                <Button Grid.Column="2" Content="Unblock" Style="{StaticResource SecondaryButton}"
                                                        Padding="8,4"
                                                        Command="{Binding DataContext.UnblockUserCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        CommandParameter="{Binding}"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Border>

        <!-- Right Panel: DM Chat or Welcome -->
        <Border Grid.Column="1">
            <Grid>
                <!-- Welcome/Empty State -->
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center"
                            Visibility="{Binding IsInDMView, Converter={StaticResource InverseBoolToVis}}">
                    <TextBlock Text="Select a friend to start chatting"
                               FontSize="18" Foreground="{StaticResource TextMutedBrush}"
                               HorizontalAlignment="Center"/>
                </StackPanel>

                <!-- DM Chat -->
                <Grid Visibility="{Binding IsInDMView, Converter={StaticResource BoolToVis}}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="48"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- DM Header -->
                    <Border Grid.Row="0" BorderBrush="{StaticResource PrimaryDarkBrush}"
                            BorderThickness="0,0,0,1">
                        <Grid Margin="16,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <Button Grid.Column="0" Content="Back" Style="{StaticResource SecondaryButton}"
                                    Margin="0,0,12,0" Padding="8,4"
                                    Command="{Binding CloseDMCommand}"/>

                            <Button Grid.Column="1" Style="{StaticResource ChannelButton}"
                                    HorizontalAlignment="Left" Padding="4"
                                    Command="{Binding ViewFriendProfileCommand}"
                                    CommandParameter="{Binding SelectedFriend}">
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <Ellipse Width="24" Height="24" Margin="0,0,8,0">
                                        <Ellipse.Fill>
                                            <ImageBrush ImageSource="{Binding SelectedFriend.AvatarUrl}"/>
                                        </Ellipse.Fill>
                                    </Ellipse>
                                    <TextBlock Text="{Binding SelectedFriend.Username}"
                                               FontSize="16" FontWeight="Bold"
                                               Foreground="{StaticResource TextPrimaryBrush}"/>
                                </StackPanel>
                            </Button>

                            <StackPanel Grid.Column="2" Orientation="Horizontal">
                                <Button Style="{StaticResource IconButton}"
                                        Width="32" Height="32" Margin="0,0,4,0"
                                        Command="{Binding ViewFriendProfileCommand}"
                                        CommandParameter="{Binding SelectedFriend}"
                                        ToolTip="View Profile">
                                    <TextBlock Text="ðŸ‘¤" FontSize="16"/>
                                </Button>
                                <Button Style="{StaticResource IconButton}"
                                        Width="32" Height="32"
                                        Command="{Binding StartCallCommand}"
                                        CommandParameter="{Binding SelectedFriend}"
                                        ToolTip="Start Call">
                                    <TextBlock Text="ðŸ“ž" FontSize="16"/>
                                </Button>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- Messages -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto"
                                  Style="{StaticResource ModernScrollViewer}">
                        <ItemsControl ItemsSource="{Binding CurrentDMHistory}" Margin="16,8">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="0,4">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>

                                        <Ellipse Grid.Column="0" Width="40" Height="40"
                                                 Margin="0,0,12,0" VerticalAlignment="Top">
                                            <Ellipse.Fill>
                                                <ImageBrush ImageSource="{Binding SenderAvatarUrl}"/>
                                            </Ellipse.Fill>
                                        </Ellipse>

                                        <StackPanel Grid.Column="1">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding SenderUsername}"
                                                           FontWeight="Medium"
                                                           Foreground="{StaticResource TextPrimaryBrush}"/>
                                                <TextBlock Text="{Binding Timestamp, StringFormat=' {0:h:mm tt}'}"
                                                           FontSize="11"
                                                           Foreground="{StaticResource TextMutedBrush}"
                                                           Margin="8,0,0,0"/>
                                            </StackPanel>
                                            <TextBlock Text="{Binding Content}"
                                                       Foreground="{StaticResource TextSecondaryBrush}"
                                                       TextWrapping="Wrap"/>
                                        </StackPanel>
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

                    <!-- Message Input -->
                    <Border Grid.Row="2" Margin="16,8,16,16">
                        <StackPanel>
                            <!-- Typing Indicator -->
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,8"
                                        Visibility="{Binding IsPartnerTyping, Converter={StaticResource BoolToVis}}">
                                <TextBlock Text="{Binding TypingUsername}" FontSize="12"
                                           Foreground="{StaticResource TextMutedBrush}" FontWeight="Medium"/>
                                <TextBlock Text=" is typing..." FontSize="12"
                                           Foreground="{StaticResource TextMutedBrush}"/>
                            </StackPanel>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBox Grid.Column="0" Style="{StaticResource ChatInputTextBox}"
                                         Text="{Binding DmMessageInput, UpdateSourceTrigger=PropertyChanged}"
                                         TextChanged="DmInput_TextChanged">
                                    <TextBox.InputBindings>
                                        <KeyBinding Key="Return" Command="{Binding SendDMCommand}"/>
                                    </TextBox.InputBindings>
                                </TextBox>
                                <Button Grid.Column="1" Content="Send" Style="{StaticResource PrimaryButton}"
                                        Margin="8,0,0,0"
                                        Command="{Binding SendDMCommand}"/>
                            </Grid>
                        </StackPanel>
                    </Border>
                </Grid>
            </Grid>
        </Border>

        <!-- Call Overlay -->
        <Grid Grid.ColumnSpan="2" Background="#E0202225"
              Visibility="{Binding IsInCall, Converter={StaticResource BoolToVis}}">
            <Border Background="{StaticResource SecondaryDarkBrush}"
                    CornerRadius="16" Width="500" Height="600"
                    VerticalAlignment="Center" HorizontalAlignment="Center">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Video/Avatar Area -->
                    <Border Grid.Row="0" Background="#1A1B1E" CornerRadius="16,16,0,0">
                        <Grid>
                            <!-- Video Preview (when enabled) -->
                            <Image x:Name="CallVideoPreview" Stretch="UniformToFill"
                                   Visibility="{Binding IsVideoEnabled, Converter={StaticResource BoolToVis}}"/>

                            <!-- Avatar (when video disabled) -->
                            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center"
                                        Visibility="{Binding IsVideoEnabled, Converter={StaticResource InverseBoolToVis}}">
                                <Grid Margin="0,0,0,24">
                                    <Ellipse Width="140" Height="140">
                                        <Ellipse.Fill>
                                            <ImageBrush ImageSource="{Binding SelectedFriend.AvatarUrl}"/>
                                        </Ellipse.Fill>
                                    </Ellipse>
                                    <!-- Voice activity ring -->
                                    <Ellipse Width="152" Height="152"
                                             Stroke="#43B581"
                                             StrokeThickness="3"
                                             Visibility="{Binding IsCallUserSpeaking, Converter={StaticResource BoolToVis}}"/>
                                </Grid>

                                <TextBlock Text="{Binding SelectedFriend.Username}"
                                           FontSize="24" FontWeight="Bold"
                                           Foreground="{StaticResource TextPrimaryBrush}"
                                           HorizontalAlignment="Center"/>

                                <TextBlock FontSize="14" HorizontalAlignment="Center"
                                           Foreground="{StaticResource TextMutedBrush}"
                                           Margin="0,8,0,0">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Text" Value="In call"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsCallUserSpeaking}" Value="True">
                                                    <Setter Property="Text" Value="Speaking..."/>
                                                    <Setter Property="Foreground" Value="#43B581"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </StackPanel>

                            <!-- Self Preview (picture-in-picture style) -->
                            <Border Width="120" Height="90" CornerRadius="8"
                                    HorizontalAlignment="Right" VerticalAlignment="Bottom"
                                    Margin="16" Background="#2B2D31"
                                    Visibility="{Binding IsSelfPreviewEnabled, Converter={StaticResource BoolToVis}}">
                                <Grid>
                                    <Image x:Name="SelfVideoPreview" Stretch="UniformToFill"/>
                                    <Ellipse Width="48" Height="48" HorizontalAlignment="Center"
                                             VerticalAlignment="Center"
                                             Visibility="{Binding IsVideoEnabled, Converter={StaticResource InverseBoolToVis}}">
                                        <Ellipse.Fill>
                                            <ImageBrush ImageSource="{Binding SelfAvatarUrl}"/>
                                        </Ellipse.Fill>
                                    </Ellipse>
                                    <!-- Muted indicator -->
                                    <Border HorizontalAlignment="Left" VerticalAlignment="Bottom"
                                            Margin="4" CornerRadius="4" Padding="4,2"
                                            Background="#ED4245"
                                            Visibility="{Binding IsMuted, Converter={StaticResource BoolToVis}}">
                                        <TextBlock Text="ðŸ”‡" FontSize="10"/>
                                    </Border>
                                </Grid>
                            </Border>

                            <!-- Audio Level Indicator -->
                            <Border HorizontalAlignment="Left" VerticalAlignment="Bottom"
                                    Margin="16" Background="#2B2D31" CornerRadius="8"
                                    Padding="12,8">
                                <Grid Width="100">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="ðŸŽ¤" FontSize="12" Margin="0,0,8,0"
                                               VerticalAlignment="Center"/>
                                    <Border Grid.Column="1" Background="#40444B" CornerRadius="2"
                                            Height="4" VerticalAlignment="Center">
                                        <Border Background="#43B581" CornerRadius="2"
                                                HorizontalAlignment="Left"
                                                Width="{Binding AudioLevelWidth}"/>
                                    </Border>
                                </Grid>
                            </Border>
                        </Grid>
                    </Border>

                    <!-- Call Duration -->
                    <Border Grid.Row="1" Background="#2B2D31" Padding="16,12">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <TextBlock Text="â±" FontSize="16" Foreground="#B5BAC1"
                                       Margin="0,0,8,0"/>
                            <TextBlock Text="{Binding CallDuration}"
                                       FontSize="18" FontWeight="Medium"
                                       Foreground="White"/>
                        </StackPanel>
                    </Border>

                    <!-- Call Controls -->
                    <Border Grid.Row="2" Background="#1E1F22" Padding="24,20"
                            CornerRadius="0,0,16,16">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <!-- Mute Button -->
                            <Button Width="52" Height="52" Margin="0,0,12,0"
                                    ToolTip="Toggle Mute"
                                    Command="{Binding ToggleMuteCommand}">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource IconButton}">
                                        <Setter Property="Background" Value="#4F545C"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsMuted}" Value="True">
                                                <Setter Property="Background" Value="#ED4245"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                                <TextBlock FontSize="20">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Text" Value="ðŸŽ¤"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsMuted}" Value="True">
                                                    <Setter Property="Text" Value="ðŸ”‡"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </Button>

                            <!-- Video Toggle Button -->
                            <Button Width="52" Height="52" Margin="0,0,12,0"
                                    ToolTip="Toggle Video"
                                    Command="{Binding ToggleVideoCommand}">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource IconButton}">
                                        <Setter Property="Background" Value="#4F545C"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsVideoEnabled}" Value="True">
                                                <Setter Property="Background" Value="#5865F2"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                                <TextBlock FontSize="20">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Text" Value="ðŸ“·"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsVideoEnabled}" Value="False">
                                                    <Setter Property="Text" Value="ðŸ“·"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </Button>

                            <!-- Screen Share Button -->
                            <Button Width="52" Height="52" Margin="0,0,12,0"
                                    ToolTip="Share Screen"
                                    Command="{Binding ToggleScreenShareCommand}">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource IconButton}">
                                        <Setter Property="Background" Value="#4F545C"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsScreenSharing}" Value="True">
                                                <Setter Property="Background" Value="#43B581"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                                <TextBlock Text="ðŸ–¥" FontSize="20"/>
                            </Button>

                            <!-- Self Preview Toggle -->
                            <Button Width="52" Height="52" Margin="0,0,24,0"
                                    ToolTip="Toggle Self Preview"
                                    Command="{Binding ToggleSelfPreviewCommand}">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource IconButton}">
                                        <Setter Property="Background" Value="#4F545C"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsSelfPreviewEnabled}" Value="True">
                                                <Setter Property="Background" Value="#5865F2"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                                <TextBlock Text="ðŸ‘" FontSize="18"/>
                            </Button>

                            <!-- End Call Button -->
                            <Button Style="{StaticResource IconButton}" Width="64" Height="52"
                                    Background="#ED4245" ToolTip="End Call"
                                    Command="{Binding EndCallCommand}">
                                <TextBlock Text="ðŸ“µ" FontSize="22"/>
                            </Button>
                        </StackPanel>
                    </Border>
                </Grid>
            </Border>
        </Grid>

        <!-- Incoming Call Overlay -->
        <Grid Grid.ColumnSpan="2" Background="#E0202225"
              Visibility="{Binding HasIncomingCall, Converter={StaticResource BoolToVis}}">
            <Border Background="{StaticResource SecondaryDarkBrush}"
                    CornerRadius="16" Width="350" Height="400"
                    VerticalAlignment="Center" HorizontalAlignment="Center">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <Ellipse Width="100" Height="100" Margin="0,0,0,24">
                        <Ellipse.Fill>
                            <ImageBrush ImageSource="{Binding CurrentCall.CallerAvatarUrl}"/>
                        </Ellipse.Fill>
                    </Ellipse>

                    <TextBlock Text="{Binding CurrentCall.CallerUsername}"
                               FontSize="20" FontWeight="Bold"
                               Foreground="{StaticResource TextPrimaryBrush}"
                               HorizontalAlignment="Center"/>

                    <TextBlock Text="Incoming Call..."
                               FontSize="14"
                               Foreground="{StaticResource TextMutedBrush}"
                               HorizontalAlignment="Center"
                               Margin="0,8,0,0"/>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,32,0,0">
                        <Button Style="{StaticResource IconButton}" Width="56" Height="56"
                                Background="{StaticResource AccentRedBrush}"
                                Margin="0,0,24,0"
                                Command="{Binding DeclineCallCommand}">
                            <TextBlock Text="ðŸ“µ" FontSize="24"/>
                        </Button>
                        <Button Style="{StaticResource IconButton}" Width="56" Height="56"
                                Background="{StaticResource AccentGreenBrush}"
                                Command="{Binding AcceptCallCommand}">
                            <TextBlock Text="ðŸ“ž" FontSize="24"/>
                        </Button>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>

        <!-- Block User Dialog -->
        <Grid Grid.ColumnSpan="2" Background="#E0202225"
              Visibility="{Binding IsBlockDialogOpen, Converter={StaticResource BoolToVis}}">
            <Border Background="{StaticResource SecondaryDarkBrush}"
                    CornerRadius="12" Width="400"
                    VerticalAlignment="Center" HorizontalAlignment="Center"
                    Padding="24">
                <StackPanel>
                    <TextBlock Text="Block User" FontSize="20" FontWeight="Bold"
                               Foreground="{StaticResource TextPrimaryBrush}"
                               Margin="0,0,0,8"/>
                    <TextBlock TextWrapping="Wrap" Foreground="{StaticResource TextSecondaryBrush}"
                               Margin="0,0,0,20">
                        <Run Text="Are you sure you want to block"/>
                        <Run Text="{Binding UserToBlock.Username}" FontWeight="Bold"/>
                        <Run Text="? They won't be able to message you or see your online status."/>
                    </TextBlock>

                    <TextBlock Text="Reason (optional)" FontSize="13"
                               Foreground="{StaticResource TextMutedBrush}"
                               Margin="0,0,0,8"/>
                    <TextBox Style="{StaticResource ModernTextBox}"
                             Text="{Binding BlockReason, UpdateSourceTrigger=PropertyChanged}"
                             Margin="0,0,0,24"/>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Cancel" Style="{StaticResource SecondaryButton}"
                                Padding="16,8" Margin="0,0,8,0"
                                Command="{Binding CloseBlockDialogCommand}"/>
                        <Button Content="Block" Style="{StaticResource DangerButton}"
                                Padding="16,8"
                                Command="{Binding ConfirmBlockCommand}"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</UserControl>
