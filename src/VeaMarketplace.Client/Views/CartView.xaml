<UserControl x:Class="VeaMarketplace.Client.Views.CartView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d"
             d:DesignHeight="800" d:DesignWidth="1000">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Styles/Colors.xaml"/>
                <ResourceDictionary Source="/Styles/Buttons.xaml"/>
            </ResourceDictionary.MergedDictionaries>

            <!-- Cart item load animation -->
            <Storyboard x:Key="CartItemLoadAnimation">
                <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                 From="0" To="1" Duration="0:0:0.3"/>
                <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)"
                                 From="20" To="0" Duration="0:0:0.3">
                    <DoubleAnimation.EasingFunction>
                        <CubicEase EasingMode="EaseOut"/>
                    </DoubleAnimation.EasingFunction>
                </DoubleAnimation>
            </Storyboard>

            <!-- Cart item hover animation -->
            <Storyboard x:Key="CartItemHoverIn">
                <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                                 To="1.01" Duration="0:0:0.15">
                    <DoubleAnimation.EasingFunction>
                        <CubicEase EasingMode="EaseOut"/>
                    </DoubleAnimation.EasingFunction>
                </DoubleAnimation>
                <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                                 To="1.01" Duration="0:0:0.15">
                    <DoubleAnimation.EasingFunction>
                        <CubicEase EasingMode="EaseOut"/>
                    </DoubleAnimation.EasingFunction>
                </DoubleAnimation>
            </Storyboard>
            <Storyboard x:Key="CartItemHoverOut">
                <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                                 To="1" Duration="0:0:0.15">
                    <DoubleAnimation.EasingFunction>
                        <CubicEase EasingMode="EaseOut"/>
                    </DoubleAnimation.EasingFunction>
                </DoubleAnimation>
                <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                                 To="1" Duration="0:0:0.15">
                    <DoubleAnimation.EasingFunction>
                        <CubicEase EasingMode="EaseOut"/>
                    </DoubleAnimation.EasingFunction>
                </DoubleAnimation>
            </Storyboard>

            <!-- Success overlay animation -->
            <Storyboard x:Key="SuccessPopIn">
                <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                 From="0" To="1" Duration="0:0:0.3"/>
                <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                                 From="0.8" To="1" Duration="0:0:0.35">
                    <DoubleAnimation.EasingFunction>
                        <BackEase EasingMode="EaseOut" Amplitude="0.3"/>
                    </DoubleAnimation.EasingFunction>
                </DoubleAnimation>
                <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                                 From="0.8" To="1" Duration="0:0:0.35">
                    <DoubleAnimation.EasingFunction>
                        <BackEase EasingMode="EaseOut" Amplitude="0.3"/>
                    </DoubleAnimation.EasingFunction>
                </DoubleAnimation>
            </Storyboard>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid Background="{StaticResource PrimaryDark}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="{StaticResource SecondaryDark}" Padding="24" BorderBrush="{StaticResource TertiaryDark}" BorderThickness="0,0,0,1">
            <Grid>
                <StackPanel>
                    <TextBlock Text="Shopping Cart" FontSize="28" FontWeight="Bold" Foreground="White"/>
                    <TextBlock FontSize="14" Foreground="{StaticResource TextSecondary}" Margin="0,4,0,0">
                        <Run Text="{Binding ItemCount}"/>
                        <Run Text="items in your cart"/>
                    </TextBlock>
                </StackPanel>
                <Button Content="Clear Cart" Style="{StaticResource SecondaryButton}"
                        Command="{Binding ClearCartCommand}" HorizontalAlignment="Right"
                        VerticalAlignment="Center" Padding="16,8"
                        Visibility="{Binding HasItems, Converter={StaticResource BoolToVisibilityConverter}}"/>
            </Grid>
        </Border>

        <!-- Main Content -->
        <Grid Grid.Row="1">
            <!-- Empty Cart Message -->
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center"
                        Visibility="{Binding IsCartEmpty, Converter={StaticResource BoolToVisibilityConverter}}">
                <TextBlock Text="Your cart is empty" FontSize="24" FontWeight="SemiBold"
                           Foreground="{StaticResource TextSecondary}" HorizontalAlignment="Center"/>
                <TextBlock Text="Browse the marketplace to find products you'll love"
                           FontSize="14" Foreground="{StaticResource TextSecondary}"
                           HorizontalAlignment="Center" Margin="0,8,0,20"/>
                <Button Content="Browse Marketplace" Style="{StaticResource AccentButton}"
                        Command="{Binding ContinueShoppingCommand}" Padding="24,12"
                        HorizontalAlignment="Center"/>
            </StackPanel>

            <!-- Cart Content -->
            <Grid Visibility="{Binding HasItems, Converter={StaticResource BoolToVisibilityConverter}}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="350"/>
                </Grid.ColumnDefinitions>

                <!-- Cart Items List -->
                <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Auto" Padding="24">
                    <ItemsControl ItemsSource="{Binding Items}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{StaticResource SecondaryDark}" CornerRadius="10"
                                        Padding="16" Margin="0,0,0,12"
                                        RenderTransformOrigin="0.5,0.5">
                                    <Border.RenderTransform>
                                        <TransformGroup>
                                            <ScaleTransform ScaleX="1" ScaleY="1"/>
                                            <TranslateTransform X="0" Y="0"/>
                                        </TransformGroup>
                                    </Border.RenderTransform>
                                    <Border.Triggers>
                                        <EventTrigger RoutedEvent="Loaded">
                                            <BeginStoryboard>
                                                <Storyboard>
                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                     From="0" To="1" Duration="0:0:0.3"/>
                                                    <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[1].(TranslateTransform.Y)"
                                                                     From="20" To="0" Duration="0:0:0.3">
                                                        <DoubleAnimation.EasingFunction>
                                                            <CubicEase EasingMode="EaseOut"/>
                                                        </DoubleAnimation.EasingFunction>
                                                    </DoubleAnimation>
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </EventTrigger>
                                        <EventTrigger RoutedEvent="MouseEnter">
                                            <BeginStoryboard>
                                                <Storyboard>
                                                    <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleX)"
                                                                     To="1.01" Duration="0:0:0.15">
                                                        <DoubleAnimation.EasingFunction>
                                                            <CubicEase EasingMode="EaseOut"/>
                                                        </DoubleAnimation.EasingFunction>
                                                    </DoubleAnimation>
                                                    <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleY)"
                                                                     To="1.01" Duration="0:0:0.15">
                                                        <DoubleAnimation.EasingFunction>
                                                            <CubicEase EasingMode="EaseOut"/>
                                                        </DoubleAnimation.EasingFunction>
                                                    </DoubleAnimation>
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </EventTrigger>
                                        <EventTrigger RoutedEvent="MouseLeave">
                                            <BeginStoryboard>
                                                <Storyboard>
                                                    <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleX)"
                                                                     To="1" Duration="0:0:0.15">
                                                        <DoubleAnimation.EasingFunction>
                                                            <CubicEase EasingMode="EaseOut"/>
                                                        </DoubleAnimation.EasingFunction>
                                                    </DoubleAnimation>
                                                    <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleY)"
                                                                     To="1" Duration="0:0:0.15">
                                                        <DoubleAnimation.EasingFunction>
                                                            <CubicEase EasingMode="EaseOut"/>
                                                        </DoubleAnimation.EasingFunction>
                                                    </DoubleAnimation>
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </EventTrigger>
                                    </Border.Triggers>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="120"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Product Image -->
                                        <Border Grid.Column="0" Width="80" Height="80" CornerRadius="8"
                                                Background="{StaticResource TertiaryDark}">
                                            <Image Source="{Binding ProductImageUrl}" Stretch="UniformToFill"/>
                                        </Border>

                                        <!-- Product Info -->
                                        <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="16,0,0,0">
                                            <TextBlock Text="{Binding ProductTitle}" FontSize="16" FontWeight="SemiBold"
                                                       Foreground="White" TextTrimming="CharacterEllipsis"/>
                                            <TextBlock FontSize="13" Foreground="{StaticResource TextSecondary}" Margin="0,4,0,0">
                                                <Run Text="Sold by"/>
                                                <Run Text="{Binding SellerUsername}" FontWeight="SemiBold"/>
                                            </TextBlock>
                                            <TextBlock Text="Item unavailable" FontSize="12" Foreground="{StaticResource Red}"
                                                       Margin="0,4,0,0"
                                                       Visibility="{Binding IsAvailable, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>
                                        </StackPanel>

                                        <!-- Quantity Controls -->
                                        <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                                            <Button Content="-" Style="{StaticResource SecondaryButton}"
                                                    Command="{Binding DataContext.DecreaseQuantityCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding}"
                                                    Width="32" Height="32" Padding="0"/>
                                            <TextBlock Text="{Binding Quantity}" FontSize="16" Foreground="White"
                                                       VerticalAlignment="Center" Margin="12,0"
                                                       MinWidth="24" TextAlignment="Center"/>
                                            <Button Content="+" Style="{StaticResource SecondaryButton}"
                                                    Command="{Binding DataContext.IncreaseQuantityCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding}"
                                                    Width="32" Height="32" Padding="0"/>
                                        </StackPanel>

                                        <!-- Price -->
                                        <TextBlock Grid.Column="3" FontSize="18" FontWeight="Bold"
                                                   Foreground="{StaticResource Green}"
                                                   VerticalAlignment="Center" HorizontalAlignment="Right">
                                            <Run Text="$"/><Run Text="{Binding Price, StringFormat='{}{0:N2}'}"/>
                                        </TextBlock>

                                        <!-- Remove Button -->
                                        <Button Grid.Column="4" Content="X" Style="{StaticResource IconButton}"
                                                Command="{Binding DataContext.RemoveItemCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}"
                                                Width="32" Height="32" Margin="16,0,0,0"
                                                Background="Transparent" Foreground="{StaticResource Red}"
                                                FontSize="14" FontWeight="Bold"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <!-- Order Summary Sidebar -->
                <Border Grid.Column="1" Background="{StaticResource SecondaryDark}"
                        BorderBrush="{StaticResource TertiaryDark}" BorderThickness="1,0,0,0">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="24">
                            <TextBlock Text="Order Summary" FontSize="20" FontWeight="Bold"
                                       Foreground="White" Margin="0,0,0,20"/>

                            <!-- Coupon Code -->
                            <TextBlock Text="Coupon Code" FontSize="14" Foreground="{StaticResource TextSecondary}"
                                       Margin="0,0,0,8"/>
                            <Grid Margin="0,0,0,16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBox Grid.Column="0" Text="{Binding CouponCode, UpdateSourceTrigger=PropertyChanged}"
                                         Background="{StaticResource TertiaryDark}" Foreground="White"
                                         BorderBrush="{StaticResource Blurple}" Padding="12,10"
                                         Visibility="{Binding HasCouponApplied, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>
                                <Border Grid.Column="0" Background="{StaticResource TertiaryDark}"
                                        CornerRadius="4" Padding="12,10"
                                        Visibility="{Binding HasCouponApplied, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{Binding AppliedCouponCode}" Foreground="{StaticResource Green}"
                                                   FontWeight="SemiBold"/>
                                        <TextBlock Text="{Binding CouponDescription}" Foreground="{StaticResource TextSecondary}"
                                                   FontSize="12" Margin="8,0,0,0" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Border>
                                <Button Grid.Column="1" Content="Apply" Style="{StaticResource AccentButton}"
                                        Command="{Binding ApplyCouponCommand}" Padding="16,10" Margin="8,0,0,0"
                                        Visibility="{Binding HasCouponApplied, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>
                                <Button Grid.Column="1" Content="Remove" Style="{StaticResource SecondaryButton}"
                                        Command="{Binding RemoveCouponCommand}" Padding="16,10" Margin="8,0,0,0"
                                        Visibility="{Binding HasCouponApplied, Converter={StaticResource BoolToVisibilityConverter}}"/>
                            </Grid>

                            <!-- Price Breakdown -->
                            <Border Background="{StaticResource TertiaryDark}" CornerRadius="8"
                                    Padding="16" Margin="0,0,0,16">
                                <StackPanel>
                                    <Grid Margin="0,0,0,8">
                                        <TextBlock Text="Subtotal" FontSize="14" Foreground="{StaticResource TextSecondary}"/>
                                        <TextBlock HorizontalAlignment="Right" FontSize="14" Foreground="White">
                                            <Run Text="$"/><Run Text="{Binding Subtotal, StringFormat='{}{0:N2}'}"/>
                                        </TextBlock>
                                    </Grid>
                                    <Grid Margin="0,0,0,8">
                                        <TextBlock Text="Fees" FontSize="14" Foreground="{StaticResource TextSecondary}"/>
                                        <TextBlock HorizontalAlignment="Right" FontSize="14" Foreground="White">
                                            <Run Text="$"/><Run Text="{Binding Fees, StringFormat='{}{0:N2}'}"/>
                                        </TextBlock>
                                    </Grid>
                                    <Grid Margin="0,0,0,8"
                                          Visibility="{Binding HasCouponApplied, Converter={StaticResource BoolToVisibilityConverter}}">
                                        <TextBlock Text="Discount" FontSize="14" Foreground="{StaticResource Green}"/>
                                        <TextBlock HorizontalAlignment="Right" FontSize="14" Foreground="{StaticResource Green}">
                                            <Run Text="-$"/><Run Text="{Binding Discount, StringFormat='{}{0:N2}'}"/>
                                        </TextBlock>
                                    </Grid>
                                    <Border Height="1" Background="{StaticResource SecondaryDark}" Margin="0,8"/>
                                    <Grid>
                                        <TextBlock Text="Total" FontSize="16" FontWeight="Bold" Foreground="White"/>
                                        <TextBlock HorizontalAlignment="Right" FontSize="18" FontWeight="Bold"
                                                   Foreground="{StaticResource Green}">
                                            <Run Text="$"/><Run Text="{Binding Total, StringFormat='{}{0:N2}'}"/>
                                        </TextBlock>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- Payment Method -->
                            <TextBlock Text="Payment Method" FontSize="14" FontWeight="SemiBold"
                                       Foreground="White" Margin="0,0,0,12"/>
                            <StackPanel Margin="0,0,0,16">
                                <RadioButton GroupName="PaymentMethod" IsChecked="True"
                                             Command="{Binding SelectPaymentMethodCommand}"
                                             CommandParameter="balance" Foreground="White" Margin="0,0,0,8">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Account Balance" FontSize="14"/>
                                    </StackPanel>
                                </RadioButton>
                                <RadioButton GroupName="PaymentMethod"
                                             Command="{Binding SelectPaymentMethodCommand}"
                                             CommandParameter="paypal" Foreground="White" Margin="0,0,0,8">
                                    <TextBlock Text="PayPal" FontSize="14"/>
                                </RadioButton>
                                <RadioButton GroupName="PaymentMethod"
                                             Command="{Binding SelectPaymentMethodCommand}"
                                             CommandParameter="crypto" Foreground="White">
                                    <TextBlock Text="Cryptocurrency" FontSize="14"/>
                                </RadioButton>
                            </StackPanel>

                            <!-- Order Notes -->
                            <TextBlock Text="Order Notes (Optional)" FontSize="14"
                                       Foreground="{StaticResource TextSecondary}" Margin="0,0,0,8"/>
                            <TextBox Text="{Binding CheckoutNotes, UpdateSourceTrigger=PropertyChanged}"
                                     Background="{StaticResource TertiaryDark}" Foreground="White"
                                     BorderBrush="{StaticResource Blurple}" Padding="12,10"
                                     TextWrapping="Wrap" AcceptsReturn="True" Height="60"
                                     Margin="0,0,0,20"/>

                            <!-- Checkout Button -->
                            <Button Content="Proceed to Checkout" Style="{StaticResource AccentButton}"
                                    Command="{Binding CheckoutCommand}" Padding="20,14" FontSize="16"
                                    IsEnabled="{Binding IsCheckoutInProgress, Converter={StaticResource InverseBoolConverter}}"/>

                            <!-- Error Message -->
                            <TextBlock Text="{Binding ErrorMessage}" Foreground="{StaticResource Red}"
                                       FontSize="13" TextWrapping="Wrap" Margin="0,12,0,0"
                                       Visibility="{Binding ErrorMessage, Converter={StaticResource NullToVisibilityConverter}}"/>
                        </StackPanel>
                    </ScrollViewer>
                </Border>
            </Grid>

            <!-- Checkout Success Overlay -->
            <Grid Visibility="{Binding ShowCheckoutSuccess, Converter={StaticResource BoolToVisibilityConverter}}"
                  Background="#E0000000">
                <Border Background="{StaticResource SecondaryDark}" CornerRadius="12"
                        VerticalAlignment="Center" HorizontalAlignment="Center"
                        Width="500" Padding="32">
                    <StackPanel>
                        <TextBlock Text="Order Successful!" FontSize="28" FontWeight="Bold"
                                   Foreground="{StaticResource Green}" HorizontalAlignment="Center"/>
                        <TextBlock Text="Thank you for your purchase" FontSize="16"
                                   Foreground="{StaticResource TextSecondary}"
                                   HorizontalAlignment="Center" Margin="0,8,0,24"/>

                        <Border Background="{StaticResource TertiaryDark}" CornerRadius="8"
                                Padding="16" Margin="0,0,0,24">
                            <StackPanel>
                                <TextBlock Text="Order Details" FontSize="14" FontWeight="SemiBold"
                                           Foreground="White" Margin="0,0,0,12"/>
                                <Grid>
                                    <TextBlock Text="Total Paid" Foreground="{StaticResource TextSecondary}"/>
                                    <TextBlock HorizontalAlignment="Right" Foreground="{StaticResource Green}"
                                               FontWeight="Bold">
                                        <Run Text="$"/><Run Text="{Binding CheckoutResult.TotalPaid, StringFormat='{}{0:N2}'}"/>
                                    </TextBlock>
                                </Grid>
                                <Grid Margin="0,8,0,0">
                                    <TextBlock Text="Orders Created" Foreground="{StaticResource TextSecondary}"/>
                                    <TextBlock Text="{Binding CheckoutResult.Orders.Count}"
                                               HorizontalAlignment="Right" Foreground="White"/>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Button Grid.Column="0" Content="Continue Shopping" Style="{StaticResource SecondaryButton}"
                                    Command="{Binding ContinueShoppingCommand}" Padding="20,12" Margin="0,0,8,0"/>
                            <Button Grid.Column="1" Content="View Orders" Style="{StaticResource AccentButton}"
                                    Command="{Binding ViewOrdersCommand}" Padding="20,12" Margin="8,0,0,0"/>
                        </Grid>
                    </StackPanel>
                </Border>
            </Grid>

            <!-- Loading Overlay -->
            <Grid Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}"
                  Background="#80000000">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <TextBlock Text="Loading..." FontSize="18" Foreground="White"/>
                </StackPanel>
            </Grid>
        </Grid>
    </Grid>
</UserControl>
